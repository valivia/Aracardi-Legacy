// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// TODO
// edit permissions per user on games/addons?
// improve card stages (how to persist data between stages? how to select which players are affected? etc)
// Properly work out user to support actual auth etc.

// USER #########################################################################################################
model User {
  created_at DateTime @default(now()) @db.Timestamp()
  updated_at DateTime @updatedAt
  id         String   @id @default(dbgenerated("uuid_generate_v4()"))

  name      String
  avatar_id String? @db.Uuid

  authored_games  Game[]
  authored_addons Addon[]
}

// GAME #########################################################################################################
model Game {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  created_at DateTime @default(now()) @db.Timestamp()
  updated_at DateTime @updatedAt

  title       String
  description String

  has_image   Boolean @default(false)
  is_official Boolean @default(false)

  // settings
  is_available_online  Boolean @default(false)
  is_available_offline Boolean @default(false)
  backlog_percentage   Float   @default(0.85)
  allow_hotjoin        Boolean @default(true)

  allow_poll  Boolean @default(true)
  allow_input Boolean @default(true)

  // Relationship
  addons  Addon[]
  authors User[]
  session Session[]
}

// ADDON #########################################################################################################
model Addon {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  created_at DateTime @default(now()) @db.Timestamp()
  updated_at DateTime @updatedAt

  title       String
  description String

  is_official Boolean @default(false)
  has_image   Boolean @default(false)
  is_draft    Boolean @default(true)

  onlineSize      Int @default(0)
  onlineNsfwSize  Int @default(0)
  offlineSize     Int @default(0)
  offlineNsfwSize Int @default(0)

  // Relationship
  game_id String @db.Uuid
  game    Game   @relation(fields: [game_id], references: [id])
  cards   Card[]
  authors User[]
}

model Card {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  created_at DateTime @default(now()) @db.Timestamp()
  updated_at DateTime @updatedAt

  minimum_players Int?
  maximum_players Int?

  is_available_online  Boolean @default(false)
  is_available_offline Boolean @default(false)
  is_nsfw              Boolean @default(false)

  stages Stage[]

  // Relationship
  addon_id String @db.Uuid
  addon    Addon  @relation(fields: [addon_id], references: [id])
}

model Stage {
  id String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid

  type StageType

  // Base
  title      String?
  time_limit Int?

  // Text Card
  text      String?
  has_image Boolean? @default(false)
  turns     Int?

  // Poll Card
  winner_points   Int?
  selection_count Int?
  options         Json[]

  // Input Card
  target String[]

  // relation
  card    Card   @relation(fields: [card_id], references: [id])
  card_id String @db.Uuid
}

enum StageType {
  TEXT
  POLL
  INPUT
}

// SESSION #########################################################################################################
model Session {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  created_at DateTime @default(now()) @db.Timestamp()

  join_code String @unique

  // Settings
  timer_multiplier Float   @default(1)
  turn_multiplier  Float   @default(1)
  allow_nsfw       Boolean @default(true)

  // Relations
  players Player[]

  game_id String @db.Uuid
  game    Game   @relation(fields: [game_id], references: [id])
}

model Player {
  id    String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  token String

  name      String
  avatar_id String @db.Uuid
  points    Int    @default(0)

  // Relations
  session    Session @relation(fields: [session_id], references: [id])
  session_id String  @db.Uuid
}
