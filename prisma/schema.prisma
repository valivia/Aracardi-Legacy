// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// TODO
// edit permissions per user on games/addons?
// improve card stages (how to persist data between stages? how to select which players are affected? etc)
// Properly work out user to support actual auth etc.

// USER #########################################################################################################
model User {
  created_at DateTime @default(now()) @db.Timestamp()
  updated_at DateTime @updatedAt
  id         String   @id @default(auto()) @map("_id") @db.ObjectId

  name String

  Game              Game[]   @relation(fields: [authored_game_ids], references: [id])
  authored_game_ids String[] @db.ObjectId

  Addon              Addon[]  @relation(fields: [authored_addon_ids], references: [id])
  authored_addon_ids String[] @db.ObjectId
}

// GAME #########################################################################################################
model Game {
  created_at DateTime @default(now()) @db.Timestamp()
  updated_at DateTime @updatedAt
  id         String   @id @default(auto()) @map("_id") @db.ObjectId

  title            String
  description      String
  default_settings Settings

  has_image            Boolean @default(false)
  is_official          Boolean @default(false)
  is_available_online  Boolean @default(false)
  is_available_offline Boolean @default(false)

  addons Addon[]

  // Relationship
  authors    User[]   @relation(fields: [author_ids], references: [id])
  author_ids String[] @db.ObjectId

  session Session[]
}

// ADDON #########################################################################################################
model Addon {
  created_at DateTime @default(now()) @db.Timestamp()
  updated_at DateTime @updatedAt
  id         String   @id @default(auto()) @map("_id") @db.ObjectId

  title       String
  description String

  is_official Boolean @default(false)
  has_image   Boolean @default(false)
  is_draft    Boolean @default(true)

  is_available_online  Boolean @default(false)
  is_available_offline Boolean @default(false)

  game_id String
  game    Game   @relation(fields: [game_id], references: [id])

  cards Card[]

  // Relationship
  authors    User[]   @relation(fields: [author_ids], references: [id])
  author_ids String[] @db.ObjectId
}

model Card {
  created_at DateTime @default(now()) @db.Timestamp()
  updated_at DateTime @updatedAt
  id         String   @id @default(auto()) @map("_id") @db.ObjectId

  minimum_players Int?
  maximum_players Int?

  stages Stage[]

  is_nsfw Boolean @default(false)

  // Relationship
  addon_id String @db.ObjectId
  addon    Addon  @relation(fields: [addon_id], references: [id])
}

type Stage {
  type StageType

  // Base
  title      String?
  time_limit Int?

  // Text Card
  text      String?
  has_image Boolean? @default(false)
  turns     Int?

  // Poll Card
  winner_points   Int?
  selection_count Int?
  options         PollOption[]

  // Input Card
  target String[]
}

enum StageType {
  TEXT
  POLL
  INPUT
}

type PollOption {
  text   String
  player String? @db.ObjectId
}

// SESSION #########################################################################################################
model Session {
  created_at DateTime @default(now()) @db.Timestamp()
  id         String   @id @default(auto()) @map("_id") @db.ObjectId

  join_code String
  settings  Settings

  players Player[]

  // Relations
  game_id String @db.ObjectId
  game    Game   @relation(fields: [game_id], references: [id])

  addon_ids String[] @db.ObjectId
}

model Player {
  id    String @id @default(auto()) @map("_id") @db.ObjectId
  token String

  name   String
  avatar String
  points Int    @default(0)

  // Relations
  session    Session @relation(fields: [session_id], references: [id])
  session_id String  @db.ObjectId
}

// OTHER #########################################################################################################
type Settings {
  use_timers Boolean @default(true)
  use_images Boolean @default(true)
  use_loop   Boolean @default(true)
  use_nsfw   Boolean @default(false)

  allow_hotjoin Boolean @default(true)

  timer_multipler Float @default(1)
  turn_multipler  Float @default(1)

  backlog_percentage Float @default(0.85)
}
